<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EmuPiano 88-Key with Users</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    user-select: none;
  }
  #user-list {
    position: fixed;
    top: 10px; right: 10px;
    width: 200px;
    max-height: 300px;
    overflow-y: auto;
    background: rgba(0,0,0,0.6);
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
  }
  #user-list h3 {
    margin: 0 0 10px 0;
    font-weight: normal;
    font-size: 16px;
  }
  #username-change {
    position: fixed;
    top: 10px; left: 10px;
  }
  #username-change input {
    padding: 5px 8px;
    font-size: 14px;
    border-radius: 4px;
    border: none;
    outline: none;
  }

  #piano {
    position: relative;
    margin: 60px auto 20px auto;
    width: 1400px; /* approx width for 88 keys */
    height: 220px;
    background: #222;
    border: 2px solid #444;
    border-radius: 6px;
    box-shadow: 0 0 20px #0af inset;
  }
  .white-key, .black-key {
    position: absolute;
    border: 1px solid #555;
    border-radius: 0 0 6px 6px;
    cursor: pointer;
  }
  .white-key {
    width: 16px;
    height: 220px;
    background: linear-gradient(to bottom, #eee, #ccc);
    z-index: 1;
    box-shadow: inset 0 5px 6px rgba(255,255,255,0.7);
  }
  .black-key {
    width: 10px;
    height: 140px;
    background: linear-gradient(to bottom, #222, #000);
    top: 0;
    z-index: 2;
    margin-left: -5px;
    box-shadow: 0 5px 8px rgba(0,0,0,0.8);
  }
  .key-label {
    position: absolute;
    bottom: 4px;
    width: 16px;
    text-align: center;
    font-size: 9px;
    color: #333;
    user-select: none;
  }
  /* Visual effect for key press */
  .key-press-effect {
    position: absolute;
    left: 0; bottom: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    background: linear-gradient(90deg, #0ff, #08f);
    opacity: 0.6;
    border-radius: 0 0 6px 6px;
    animation: riseFade 0.8s ease forwards;
  }
  @keyframes riseFade {
    0% { transform: translateY(0); opacity: 0.6;}
    100% { transform: translateY(-100px); opacity: 0;}
  }
</style>
</head>
<body>

<div id="username-change">
  <label for="usernameInput" style="color:#0af;">Your Name:</label><br/>
  <input id="usernameInput" type="text" maxlength="15" placeholder="Enter your name" />
</div>

<div id="user-list">
  <h3>Users in Lobby</h3>
  <ul id="usersUl" style="padding-left: 20px; margin:0;"></ul>
</div>

<div id="piano"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAdy-R98rUg23ibhbYVNRZfUfeY4Uy7TPs",
    authDomain: "emupiano-4b7ac.firebaseapp.com",
    databaseURL: "https://emupiano-4b7ac-default-rtdb.firebaseio.com",
    projectId: "emupiano-4b7ac",
    storageBucket: "emupiano-4b7ac.appspot.com",
    messagingSenderId: "1035222015142",
    appId: "1:1035222015142:web:ff34b888c86ed67cd36867",
    measurementId: "G-7NVMZMB8RH"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Anonymous auth & user data setup
  let currentUser = null;
  let userId = null;
  let username = localStorage.getItem('username') || "Guest";

  // Piano key data: 88 keys from MIDI 21 (A0) to 108 (C8)
  const TOTAL_KEYS = 88;
  const FIRST_MIDI_NOTE = 21;

  // Which notes have black keys above?
  // Pattern of black keys in octave (C to B): C# D#   F# G# A#
  // White keys are numbered from 0..87
  const blackKeyOffsets = [1, 3, 6, 8, 10];

  // Helper to check if a MIDI note is black key
  function isBlackKey(midiNote) {
    const noteInOctave = midiNote % 12;
    return blackKeyOffsets.includes(noteInOctave);
  }

  // Calculate position of white keys and black keys
  // White keys index for layout - black keys positioned relative to white keys
  // We count white keys to position black keys

  // Map white keys only with their position for left style
  // White keys widths: 16px, black keys widths: 10px

  const whiteKeyWidth = 16;
  const blackKeyWidth = 10;

  // Build piano UI
  const piano = document.getElementById('piano');

  // Track count of white keys so we can position black keys correctly
  let whiteKeyCount = 0;

  // Store references to keys for event handling
  const keyElements = {};

  for(let i = 0; i < TOTAL_KEYS; i++) {
    const midiNote = FIRST_MIDI_NOTE + i;
    const black = isBlackKey(midiNote);

    if(!black) {
      // White key
      const key = document.createElement('div');
      key.classList.add('white-key');
      key.style.left = (whiteKeyCount * whiteKeyWidth) + 'px';
      key.dataset.midi = midiNote;
      key.title = midiNote;

      // Add note label (only for white keys)
      const label = document.createElement('div');
      label.classList.add('key-label');
      label.style.left = (whiteKeyCount * whiteKeyWidth) + 'px';
      label.textContent = getNoteName(midiNote);
      piano.appendChild(label);

      piano.appendChild(key);
      keyElements[midiNote] = key;
      whiteKeyCount++;
    }
  }

  // Now add black keys positioned relative to white keys
  whiteKeyCount = 0;
  for(let i = 0; i < TOTAL_KEYS; i++) {
    const midiNote = FIRST_MIDI_NOTE + i;
    const black = isBlackKey(midiNote);

    if(!black) {
      whiteKeyCount++;
    } else {
      // Black key position: sits between whiteKeyCount-1 and whiteKeyCount
      const key = document.createElement('div');
      key.classList.add('black-key');
      // Position black key slightly left to sit above white keys
      // The offset calculation is tricky; it depends on which black key
      const offset = (whiteKeyCount - 1) * whiteKeyWidth + whiteKeyWidth - blackKeyWidth/2;
      key.style.left = offset + 'px';
      key.dataset.midi = midiNote;
      key.title = midiNote;

      piano.appendChild(key);
      keyElements[midiNote] = key;
    }
  }

  // Utility: Convert MIDI note to note name (like C4, D#3)
  function getNoteName(midiNote) {
    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const octave = Math.floor(midiNote / 12) - 1;
    return noteNames[midiNote % 12] + octave;
  }

  // Play animation on key press (color rising effect)
  function animateKeyPress(keyElem) {
    const effect = document.createElement('div');
    effect.className = 'key-press-effect';
    keyElem.appendChild(effect);
    effect.addEventListener('animationend', () => {
      effect.remove();
    });
  }

  // Key click handler
  function onKeyClick(e) {
    const keyElem = e.currentTarget;
    const midiNote = +keyElem.dataset.midi;
    animateKeyPress(keyElem);
    // Here you can also send the note to the backend or play sound
    console.log('Key pressed:', getNoteName(midiNote), midiNote);
    // Example: sendNoteToFirebase(midiNote);
  }

  // Attach click listeners to all keys
  Object.values(keyElements).forEach(key => {
    key.addEventListener('mousedown', onKeyClick);
  });

  // ----- USER MANAGEMENT -----

  // Sign in anonymously
  auth.signInAnonymously().catch(console.error);

  // On auth state change, set up user data
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      userId = user.uid;

      // Load username from local storage or from DB
      username = localStorage.getItem('username') || "Guest";

      // Update username input value
      document.getElementById('usernameInput').value = username;

      // Save or update username in DB
      updateUserPresence();

      // Setup presence listeners
      setupPresenceListeners();
    } else {
      currentUser = null;
      userId = null;
    }
  });

  // Update user presence in DB
  function updateUserPresence() {
    if(!userId) return;
    const userRef = db.ref('users/' + userId);
    userRef.set({
      username,
      lastActive: Date.now()
    });
    // Remove user from DB when disconnect
    userRef.onDisconnect().remove();
  }

  // Listen for username input changes
  const usernameInput = document.getElementById('usernameInput');
  usernameInput.addEventListener('change', e => {
    const val = e.target.value.trim();
    if(val.length > 0 && val.length <= 15) {
      username = val;
      localStorage.setItem('username', username);
      updateUserPresence();
    } else {
      // Reset to previous valid username if invalid
      e.target.value = username;
    }
  });

  // Show list of users in lobby
  const usersUl = document.getElementById('usersUl');

  function setupPresenceListeners() {
    const usersRef = db.ref('users');
    usersRef.on('value', snapshot => {
      const users = snapshot.val() || {};
      usersUl.innerHTML = '';
      Object.entries(users).forEach(([uid, data]) => {
        const li = document.createElement('li');
        li.textContent = data.username || 'Guest';
        if(uid === userId) {
          li.style.fontWeight = 'bold';
          li.textContent += ' (You)';
        }
        usersUl.appendChild(li);
      });
    });
  }
</script>

</body>
</html>
