<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EmuPiano</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Open Sans', sans-serif;
    }
    body {
      margin: 0;
      background: #121212;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(0,0,0,0.7);
      border-bottom: 1px solid #333;
    }
    #roomInput {
      background: #1f1f1f;
      border: 1px solid #333;
      color: white;
      padding: 5px;
      width: 200px;
    }
    #container {
      display: flex;
      height: 100%;
    }
    #left-panel {
      width: 300px;
      background: rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
    }
    #userList {
      padding: 5px;
      font-size: 14px;
      border-bottom: 1px solid #333;
      background: rgba(0,0,0,0.3);
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #messages {
      flex: 1;
      padding: 5px;
      overflow-y: auto;
      font-size: 13px;
      background: rgba(0,0,0,0.3);
    }
    #input {
      padding: 5px;
      border: none;
      border-top: 1px solid #333;
      background: #181818;
      color: white;
    }
    #input:focus {
      outline: none;
    }
    #piano-container {
      flex: 1;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      background: #202020;
      position: relative;
    }
    #piano {
      display: flex;
      padding: 20px;
    }
    .key {
      width: 40px;
      height: 180px;
      background: white;
      margin: 1px;
      border: 1px solid #333;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      font-size: 10px;
      color: black;
    }
    .key.playing {
      background: lightblue;
    }
    #menu {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
    }
    #menu button {
      margin: 3px;
      background: #333;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #menu button:hover {
      background: #444;
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <input id="roomInput" placeholder="Room name..." />
    <button onclick="joinRoom()">Join Room</button>
    <span style="font-weight: bold;">ðŸŽ¹ EmuPiano</span>
  </div>

  <div id="container">
    <div id="left-panel">
      <div id="userList">Users:</div>
      <div id="chat">
        <div id="messages"></div>
        <input id="input" placeholder="Type here..." onkeydown="if(event.key==='Enter') sendMessage()" />
      </div>
    </div>
    <div id="piano-container">
      <div id="piano"></div>
      <div id="menu">
        <button onclick="toggleTheme()">ðŸŒ— Theme</button>
        <button onclick="kickUser()">ðŸ‘¢ Kick</button>
        <button onclick="muteUser()">ðŸ”‡ Mute</button>
        <button onclick="saveSong()">ðŸ’¾ Save</button>
        <button onclick="loadSong()">ðŸ“‚ Load</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAdy-R98rUg23ibhbYVNRZfUfeY4Uy7TPs",
      authDomain: "emupiano-4b7ac.firebaseapp.com",
      databaseURL: "https://emupiano-4b7ac-default-rtdb.firebaseio.com",
      projectId: "emupiano-4b7ac",
      storageBucket: "emupiano-4b7ac.appspot.com",
      messagingSenderId: "1035222015142",
      appId: "1:1035222015142:web:ff34b888c86ed67cd36867",
      measurementId: "G-7NVMZMB8RH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Main
    const keys = ['C','D','E','F','G','A','B'];
    const piano = document.getElementById('piano');
    const userList = document.getElementById('userList');
    const messages = document.getElementById('messages');
    let username = "User" + Math.floor(Math.random() * 1000);
    let currentRoom = "lobby";
    let usersRef, chatRef, pianoRef;
    let isDark = true;
    let mutedUsers = {};
    let isOwner = false;

    function joinRoom() {
      const room = document.getElementById('roomInput').value.trim();
      if (!room) return;
      if (usersRef) usersRef.off();
      if (chatRef) chatRef.off();
      if (pianoRef) pianoRef.off();
      currentRoom = room;
      isOwner = username === "Emulation12";

      usersRef = db.ref(`rooms/${room}/users`);
      chatRef = db.ref(`rooms/${room}/chat`);
      pianoRef = db.ref(`rooms/${room}/notes`);

      usersRef.on('value', snap => {
        const val = snap.val() || {};
        userList.innerHTML = "Users:<br>" + Object.keys(val).join("<br>");
      });

      chatRef.on('child_added', snap => {
        const { sender, message } = snap.val();
        if (!mutedUsers[sender]) {
          messages.innerHTML += `<div><b>${sender}:</b> ${message}</div>`;
          messages.scrollTop = messages.scrollHeight;
        }
      });

      pianoRef.on('child_added', snap => {
        const { note } = snap.val();
        playSound(note);
        const el = document.querySelector(`.key[data-note="${note}"]`);
        if (el) {
          el.classList.add("playing");
          setTimeout(() => el.classList.remove("playing"), 200);
        }
      });

      usersRef.child(username).set(true);
      usersRef.child(username).onDisconnect().remove();
    }

    function sendMessage() {
      const val = document.getElementById('input').value.trim();
      if (!val) return;
      chatRef.push({ sender: username, message: val });
      document.getElementById('input').value = "";
    }

    function sendNote(note) {
      pianoRef.push({ note });
    }

    function playSound(note) {
      const audio = new Audio(`https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/piano-mp3/${note}.mp3`);
      audio.play();
    }

    function buildPiano() {
      for (let note of keys) {
        const el = document.createElement('div');
        el.className = 'key';
        el.innerText = note;
        el.dataset.note = note;
        el.onclick = () => {
          sendNote(note);
        };
        piano.appendChild(el);
      }
    }
    buildPiano();

    function toggleTheme() {
      isDark = !isDark;
      document.body.style.background = isDark ? "#121212" : "#eeeeee";
      document.body.style.color = isDark ? "white" : "black";
    }

    function kickUser() {
      if (!isOwner) return alert("Only Emulation12 can kick.");
      const name = prompt("Kick who?");
      if (name) db.ref(`rooms/${currentRoom}/users/${name}`).remove();
    }

    function muteUser() {
      const name = prompt("Mute who?");
      if (name) mutedUsers[name] = true;
    }

    function saveSong() {
      let song = [];
      pianoRef.once('value', snap => {
        snap.forEach(child => {
          song.push(child.val().note);
        });
        localStorage.setItem("savedSong", JSON.stringify(song));
        alert("Song saved!");
      });
    }

    function loadSong() {
      const song = JSON.parse(localStorage.getItem("savedSong") || "[]");
      let i = 0;
      const interval = setInterval(() => {
        if (i >= song.length) return clearInterval(interval);
        sendNote(song[i++]);
      }, 300);
    }

    // Auto-join default room
    document.getElementById('roomInput').value = "lobby";
    joinRoom();
  </script>
</body>
</html>
